#!/usr/bin/env python3

import os
import sys
import subprocess
import crypt
import getpass
import re

# ---------- Root / Sudo Check ----------
if os.geteuid() != 0:
    print("❌ This tool must be run as root or with sudo")
    sys.exit(1)

print("\nBulk User Creation Tool (type 'exit' to quit)\n")

# ---------- Password Complexity Function ----------
def check_password_complexity(password):
    if len(password) < 8:
        return "Password must be at least 8 characters long"
    if not re.search(r"[A-Z]", password):
        return "Password must contain at least one uppercase letter"
    if not re.search(r"[a-z]", password):
        return "Password must contain at least one lowercase letter"
    if not re.search(r"[0-9]", password):
        return "Password must contain at least one digit"
    if not re.search(r"[!@#$%^&*()_+=\-{}[\]:;\"'<>,.?/]", password):
        return "Password must contain at least one special character"
    return None

while True:
    username = input("Enter username: ").strip()

    if username.lower() == "exit":
        print("\nExiting user creation tool.")
        break

    if not username:
        print("❌ Username cannot be empty\n")
        continue

    fullname = input("Enter full name (display name): ").strip()
    shell = input("Enter login shell [/bin/bash]: ").strip() or "/bin/bash"
    home_dir = input(f"Enter home directory [/home/{username}]: ").strip() or f"/home/{username}"

    # ---------- Password Input (Hidden) ----------
    password = getpass.getpass("Enter password: ")
    confirm_password = getpass.getpass("Confirm password: ")

    if password != confirm_password:
        print("❌ Passwords do not match\n")
        continue

    if not password:
        print("❌ Password cannot be empty\n")
        continue

    # ---------- Password Complexity Check ----------
    error = check_password_complexity(password)
    if error:
        print(f"❌ Weak password: {error}\n")
        continue

    # ---------- SHA512 Password Hash ----------
    hashed_password = crypt.crypt(password, crypt.mksalt(crypt.METHOD_SHA512))

    # ---------- User Creation ----------
    try:
        subprocess.run(
            [
                "useradd",
                "-m",
                "-d", home_dir,
                "-s", shell,
                "-c", fullname,
                "-p", hashed_password,
                username
            ],
            check=True
        )
        print(f"✅ User '{username}' created successfully\n")

    except subprocess.CalledProcessError:
        print(f"❌ Failed to create user '{username}' (maybe already exists?)\n")

